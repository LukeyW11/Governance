<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UK Parliament Seats</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body style="font-family:sans-serif; text-align:center; margin-top:50px;">
  <h1>UK Parliament Seat: Cambridge</h1>
  <button id="runButton">Run for this seat</button>
  <p id="status"></p>

  <script>
// Initialize Supabase
const supabaseUrl = 'https://tjgtbhoiptrjcrextgyl.supabase.co';
const supabaseKey = 'sb_secret_60BokZKoPtUxZ0dqLaXY2w_gum3WqU_';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const runButton = document.getElementById('runButton');
const status = document.getElementById('status');

async function getCurrentHolder() {
  const { data, error } = await supabase
    .from('seats')
    .select('name, current_holder_id, users(username)')
    .eq('name', 'Cambridge')
    .single();

  if (error) {
    status.textContent = "Error loading seat: " + error.message;
  } else if (data.current_holder_id) {
    status.textContent = "Current holder: " + data.users.username;
    runButton.disabled = true;
  } else {
    status.textContent = "Seat is vacant. You can run!";
    runButton.disabled = false;
  }
}

// When clicking "Run for this seat"
runButton.addEventListener('click', async () => {
  const email = prompt("Enter your email:");
  const username = prompt("Enter your username:");

  // Sign up or send magic login link
  let { data: user, error } = await supabase.auth.signUp({ email });
  if (error && error.message.includes('already registered')) {
    await supabase.auth.signInWithOtp({ email });
    alert("Check your email to log in!");
    return;
  } else if (error) {
    alert("Error: " + error.message);
    return;
  }

  // Insert into users table (ignore duplicates)
  await supabase
    .from('users')
    .upsert({ email, username, id: user?.user?.id })
    .select();

  // Claim the seat if vacant
  const { data, error: seatError } = await supabase
    .from('seats')
    .update({ current_holder_id: user.user.id })
    .eq('name', 'Cambridge')
    .is('current_holder_id', null)
    .select();

  if (seatError) {
    status.textContent = "Error claiming seat: " + seatError.message;
  } else if (data.length === 0) {
    status.textContent = "Seat already taken!";
  } else {
    status.textContent = username + " is now the holder of Cambridge!";
    runButton.disabled = true;
  }
});

// Initial load
getCurrentHolder();

  </script>
</body>
</html>
